<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terralytic - Professional Carbon Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.polyfill.io/v3/polyfill.min.js"></script>
    <style>
        :root {
            --eco-green: #2ecc71;
            --dark-bg: #1a1a1a;
            --text-light: #f0f0f0;
            --error-red: #ff4444;
        }

        /* Previous CSS styles remain unchanged */
        /* ... [Include all previous CSS styles here] ... */
    </style>
</head>
<body>
    <!-- Cookie Consent Banner -->
    <div class="cookie-consent" id="cookieConsent">
        <!-- Keep existing cookie consent HTML -->
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
    </div>

    <!-- Main Content -->
    <div class="header">
        <h1>🌍 Terralytic Environmental Impact Report</h1>
        <p>Professional website carbon footprint analysis</p>
    </div>

    <!-- Input Section -->
    <div class="input-group">
        <input type="url" id="websiteUrl" 
               placeholder="https://example.com"
               autocomplete="off"
               aria-label="Website URL">
        <select id="hostingType" aria-label="Hosting type">
            <option value="green">🌿 Green Hosting</option>
            <option value="standard">⚡ Standard Hosting</option>
        </select>
        <button onclick="initAnalysis()" id="analyzeBtn">Analyze Website</button>
    </div>

    <!-- Error Display -->
    <div id="errorBox" class="error-alert" style="display: none;">
        <span onclick="this.parentElement.style.display='none'" 
              style="cursor:pointer;float:right">&times;</span>
        <p id="errorMessage"></p>
    </div>

    <!-- Results Section -->
    <div class="result-section" id="resultSection">
        <div class="comparison-card">
            <h3>📈 Environmental Impact Analysis</h3>
            <p>🛢️ <strong><span id="co2Amount">0.00g</span> CO₂</strong> per visit</p>
            <p>🚗 Equivalent to driving <strong><span id="carMiles">0.0000 miles</span></strong></p>
            <p>💡 Equal to powering <strong><span id="bulbHours">0.00 hours</span></strong> of a LED bulb</p>
        </div>

        <canvas id="carbonChart" aria-label="Environmental impact comparison chart"></canvas>

        <div class="button-group">
            <button onclick="generateReport()">📥 Download Full Report</button>
            <button onclick="shareResults()">📤 Share Analysis</button>
        </div>
    </div>

    <script>
        'use strict';
        
        // Rate Limiting Setup
        const RATE_LIMIT = {
            maxRequests: 10,
            periodMinutes: 1,
            getKey: () => localStorage.getItem('user-id') || 'anon'
        };

        let currentChart = null;
        const HostingFactors = { green: 0.3, standard: 0.7 };

        // Fixed Car Miles Calculation
        async function calculateImpact(url, hostingType) {
            try {
                const parsedUrl = new URL(url);
                const pageSize = await getActualPageSize(parsedUrl);
                const hostingFactor = await getHostingFactor(hostingType);
                
                // Convert page size to MB
                const pageSizeMB = pageSize / (1024 * 1024);
                
                // CO₂ calculation (grams)
                const dataTransferCO2 = pageSizeMB * 0.5;
                const totalCO2 = dataTransferCO2 + hostingFactor;
                
                // Car miles calculation (fixed precision)
                const milesDriven = (totalCO2 / 404).toFixed(4); // 404g CO₂ per mile
                
                return {
                    co2: totalCO2.toFixed(2),
                    chartCO2: (totalCO2 * 1000).toFixed(0), // Convert to mg
                    miles: milesDriven,
                    bulb: (totalCO2 / 0.05).toFixed(1)
                };
            } catch (error) {
                throw new Error('Calculation failed: ' + error.message);
            }
        }

        // Rate Limited Analysis Initiation
        async function initAnalysis() {
            try {
                checkRateLimit();
                showLoading(true);
                
                const url = document.getElementById('websiteUrl').value;
                const hosting = document.getElementById('hostingType').value;
                
                validateInput(url);
                const impact = await calculateImpact(url, hosting);
                
                displayResults(impact);
                trackUsage();
            } catch (error) {
                showError(error.message);
            } finally {
                showLoading(false);
            }
        }

        // Rate Limiting Implementation
        function checkRateLimit() {
            const now = Date.now();
            const key = RATE_LIMIT.getKey();
            const state = JSON.parse(localStorage.getItem(key) || '{"count":0,"reset":0}');
            
            if (now > state.reset) {
                state.count = 0;
                state.reset = now + (RATE_LIMIT.periodMinutes * 60 * 1000);
            }
            
            if (state.count >= RATE_LIMIT.maxRequests) {
                throw new Error(`Usage limit exceeded (${RATE_LIMIT.maxRequests} analyses per minute)`);
            }
            
            state.count++;
            localStorage.setItem(key, JSON.stringify(state));
        }

        // User Preference Storage
        function savePreferences() {
            localStorage.setItem('preferredHosting', document.getElementById('hostingType').value);
        }

        function loadPreferences() {
            const preferred = localStorage.getItem('preferredHosting');
            if (preferred) document.getElementById('hostingType').value = preferred;
        }

        // Monitoring Setup
        function trackUsage() {
            if (navigator.sendBeacon) {
                const data = new FormData();
                data.append('url', document.getElementById('websiteUrl').value);
                navigator.sendBeacon('/analytics', data);
            }
        }

        // Previous functions (getActualPageSize, displayResults, etc.) remain same
        // ... [Include all previous JavaScript functions here] ...

        // Initialize
        checkCookies();
        loadPreferences();
        document.getElementById('websiteUrl').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') initAnalysis();
        });
    </script>
</body>
</html>
